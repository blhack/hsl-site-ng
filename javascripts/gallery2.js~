function listener(e) {
    var l = document.createElement("li");
    //console.log("listener:" + e.type);

    var t = (e.type.match(/start$/i)?1:
             (e.type.match(/end$/i)?2:
              (e.type.match(/iteration$/i)?3:0)));

    switch(t) {
    case 1:
        l.innerHTML = "Started: elapsed time is " + e.elapsedTime;
        break;
    case 2:
        l.innerHTML = "Ended: elapsed time is " + e.elapsedTime;
        break;
    case 3:
        l.innerHTML = "New loop started at time " + e.elapsedTime;
        break;
    }
    document.getElementById("output").appendChild(l);
}

var flickrImages = [];
var flickrLimit = 20;
var previousIdx = -1;
var num = -2;
var imgDiv = document.getElementById("gallery");
var imgNextDiv = document.getElementById("gallery_next");
var galleryDiv = document.getElementById("gallery_space");

/*
var e = document.getElementById("watchme");
e.addEventListener("animationstart", listener, false);
e.addEventListener("animationend", listener, false);
e.addEventListener("animationiteration", listener, false);
e.addEventListener("webkitAnimationStart", listener, false);
e.addEventListener("webkitAnimationEnd", listener, false);
e.addEventListener("webkitAnimationIteration", listener, false);
e.className = "fade-test";
*/

var newImage = function() {
    var num=0;
    while (flickrImages.length>1 && ((num=Math.floor(Math.random()*flickrImages.length)) == previousIdx)) {}
    previousIdx = num;
    return num;
/*
    imgDiv.style.background = "url("+flickrImages[num].image_b+") no-repeat";
    galleryDiv.onclick = function() {
        alert("Clicked!");
        window.location = flickrImages[num].link;
    };
*/
    //imgDiv.addEventListener('click',function(e){alert("clicked!");});
};

function swapper(e) {
    imgDiv.style.background = imgNextDiv.style.background;
    imgDiv.style.opacity = 1;
    var next = newImage();
    imgNextDiv.style.background = "url("+flickrImages[next].image_b+") no-repeat";
};

function imglistener(e) {
    imgDiv.style = imgNextDiv.style;
    imgDiv.click = imgNextDiv.click;
};

// Do the jquery flick goodness
jflickrfeed(
    {
        limit: flickrLimit,
        qstrings: {
            tags: 'publish',
            id: '60827818@N07'
        },
        useTemplate: false,
        itemCallback: function(item){
            flickrImages.push(item);
        }
    },
    function(){

        var next = newImage();
        var curr = newImage();

        imgDiv.style.background = "url("+flickrImages[curr].image_b+") no-repeat";
        imgNextDiv.style.background = "url("+flickrImages[curr].image_b+") no-repeat";

        var e = imgDiv;
        e.addEventListener("animationiteration", swapper, false);
        e.addEventListener("webkitAnimationIteration", swapper, false);
        e.className = "fade-test";

        newImage();
        timeout = setInterval(newImage, 10000)
        //initialize(flickrImages);
        console.log(flickrImages);
    });

